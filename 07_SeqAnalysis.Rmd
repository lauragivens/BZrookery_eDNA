---
title: "07_SeqAnalysis"
author: "Laura Givens"
date: "2025-04-10"
output: html_document
---

# Load  
Load libraries  
```{r,message=FALSE}
library(phyloseq)
library(tidyverse)
library(ggplot2)
library(cowplot)
```

Load data  
```{r load}
dir_data <- '/Users/lauragivens/Desktop/R/BZrookery_eDNA/Rdata'
dir_results <- "/Volumes/Fuji/Mangroves/2025_0319_Givens_Canty_Rookery_COI/cutadapt/results"

ps <- readRDS(paste0(dir_results,"/ps.rds"))
ps.troph <- readRDS(paste0(dir_results,"/ps.troph.rds"))

taxa <- readRDS(paste0(dir_results,"/taxtable.rds"))
taxa_troph <- readRDS(paste0(dir_results,"/taxtable.wtroph.rds"))
curated_lulu <- readRDS(paste0(dir_results,'/lulu-clustertable.rds'))
curated_asv <- readRDS(paste0(dir_results,"/asvtable.rds"))
samplelist <- readRDS(paste0(dir_results,'/metadata.rds'))
```

```{r}
ggplot2::theme_set(theme_cowplot() + theme(
  legend.position = "bottom",
  panel.border = element_rect(color='black'),
  legend.box.margin = margin(5,5,5,5),
  legend.spacing = unit(0,"pt"),
  plot.title = element_text(face="bold"),
  plot.caption = element_text(face="italic"),
  text = element_text(size=(15),family="Times"),
  legend.key.height = unit(10,"pt"),
  legend.key.width = unit(10,"pt")
))
```


# Phyloseq  
About the ps objects  
```{r ps}
ps
ps.troph
```
```{r}
troph_edit <- taxa_troph %>% mutate(.,
                      Trophic.Base = word(Trophic.Index,sep=" ") %>% as.numeric(),
                      Trophic.Round = round(as.numeric(Trophic.Base)),
                      .after = Trophic.Index
                      ) 

tax_table(ps.troph) <- as.matrix(troph_edit)

samplelist$Date <- lubridate::dmy(samplelist$Date)
samplelist$Month <- lubridate::month(samplelist$Date)
samplelist <- samplelist %>% mutate(.,
                                    Rookery=case_when(Rookery=="R" ~ "Rookery",
                                                      Rookery=="NR" ~ "Non-rookery"),
                                    Site=case_when(Site=="HI" ~ "Hicks Caye",
                                                   Site=="TA" ~ "Turneffe Atoll",
                                                   Site=="DC" ~ "Drowned Caye"),
                                    Side=case_when(Side=="L" ~ "Leeward",
                                                   Side=="W" ~ "Windward"))

sample_data(ps.troph) <- samplelist
```

### Prune ps  
```{r prune_ps}
prune.ps <- ps %>% 
  prune_samples(sample_sums(.)>50,.) %>%
  subset_samples(.,Rookery!='Blank' & Rookery != 'Practice') 
```

```{r prune_100}
top100 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:100]

t100.ps <- prune.ps %>% prune_taxa(top100, .) 
```

```{r prune_1pct}
mean_cutoff = 0.01
mean_test = function(x) {
  mean(x) >= mean_cutoff
}
 prune.ps.1pct <- prune.ps %>% transform_sample_counts(function(x) x/sum(x)) %>% 
   filter_taxa(mean_test, prune=TRUE)
```

### Prune trophic ps  
```{r}
prune.ps.troph <- ps.troph %>% 
  prune_samples(sample_sums(.)>50,.) %>%
  subset_samples(.,Rookery!='Blank' & Rookery != 'Practice') 
```

```{r}
prune.ps.troph.1pct <- prune.ps.troph %>% filter_taxa(mean_test,prune=TRUE)
prune.ps.troph.t100 <- prune.ps.troph  %>% prune_taxa(top100, .) 
```

```{r}
prune.ps.troph.melt <- psmelt(prune.ps.troph)
prune.ps.troph.melt.rel <- psmelt(prune.ps.troph %>% transform_sample_counts(function(x) x/sum(x)))
```

# Descriptive Stats  
Sequence distribution  
```{r distribution}
plot_bar(ps)
```

Unique taxa  
```{r num_taxa}
  tibble(Rank = rank_names(ps)) %>% 
    rowwise %>%
    mutate(Unique = length(get_taxa_unique((ps),Rank)))
```

# Tax distribution by sample  
Raw  
```{r taxsam-raw}
ps %>%
  plot_bar(., x="Sample.Name") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_wrap(Site~Rookery,scales='free_x') + 
  theme(legend.key.size = unit(2,'pt'),
        legend.key.spacing = unit(0.1,'pt'),
        legend.position = 'none')
```

Pruned  
```{r taxsam-pr}
prune.ps %>%
  plot_bar(., x="Sample.Name") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_wrap(Site~Rookery,scales='free_x') + 
  theme(legend.key.size = unit(2,'pt'),
        legend.key.spacing = unit(0.1,'pt'),
        legend.position = 'none')
```

Top 100  
```{r taxsam-t100}
t100.ps %>% 
  plot_bar(., x="Sample.Name") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_grid(Site~Rookery,scales='free') + 
  theme(legend.position = 'none')
```

1 pct  
```{r taxsam-1pct}
prune.ps.1pct %>% 
  plot_bar(., x="Sample.Name") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_grid(Site~Rookery,scales='free_x') + 
  theme(legend.position = 'none')
```

# Tax distribution by date  
Raw  
```{r taxdate-raw}
ps %>%
  plot_bar(., x="Date") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_wrap(~Rookery,scales='free_x') + 
  theme(legend.key.size = unit(2,'pt'),
        legend.key.spacing = unit(0.1,'pt'),
        legend.position = 'none')
```

Pruned  
```{r taxdate-pr}
prune.ps %>%
  plot_bar(., x="Date") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_wrap(~Rookery,scales='free_x') + 
  theme(legend.key.size = unit(2,'pt'),
        legend.key.spacing = unit(0.1,'pt'),
        legend.position = 'none')
```

Top 100  
```{r taxdate-t100}
t100.ps %>% 
  plot_bar(., x="Date") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_grid(~Rookery,scales='free') + 
  theme(legend.position = 'none')
#ggsave("/Users/lauragivens/Downloads/t100.rookery.facet.png",height=10,width=15)
```

1 pct  
```{r taxdate-1pct}
prune.ps.1pct %>% 
  plot_bar(., x="Date") + 
  geom_bar(stat='identity',position='stack',aes(fill=species)) + 
  facet_grid(~Rookery,scales='free_x') + 
  theme(legend.position = 'none')
#ggsave("/Users/lauragivens/Downloads/prune.1pct.rookery.facet.png",height=10,width=20)
```

# PS trophic  
```{r}
prune.ps.troph  %>% transform_sample_counts(.,function(x) x/sum(x)) %>%
  plot_bar(.) + 
  geom_bar(stat='identity',position='stack',aes(fill=Trophic.Round)) + 
  facet_grid(Site~Rookery,scales='free_x') 
```

```{r}
prune.ps.troph.melt %>% group_by(Date,Site,Rookery,Trophic.Round) %>% summarize(Abundance=sum(Abundance)) %>% mutate(Abundance=Abundance/sum(Abundance)) %>%
ggplot(.,
       aes(x=Date,y=Abundance,
           group=Trophic.Round,color=Trophic.Round)) + 
  geom_line() + geom_path() + facet_grid(Site~Rookery)
```

```{r}
prune.ps.troph.t100 %>% psmelt() %>% group_by(Date,Site,Rookery,Fishing.Vulnerability) %>% summarize(Abundance=sum(Abundance)) %>% mutate(Abundance=Abundance/sum(Abundance)) %>%
ggplot(.,
       aes(x=Date,y=Abundance,
           group=Fishing.Vulnerability,color=Fishing.Vulnerability)) + 
  geom_line() + geom_path() + facet_grid(Site~Rookery)
```

```{r}
#prune.ps.troph.melt.rel %>% 
#  filter(Commercially.Imp.Occurring.IN.Belize==TRUE) %>% 
prune.ps.troph.1pct %>% 
  transform_sample_counts(function(x) x/sum(x)) %>% subset_taxa(Commercially.Imp.Occurring.IN.Belize==TRUE & !is.na(Species)) %>%
  plot_bar(x="Date",fill="Species") + 
  geom_bar(aes(color=Species,fill=Species),stat='identity',position='stack') + 
  facet_grid(Site~Rookery)
```


# Richness  
```{r rich-samplename}
plot_richness(ps,x="Sample.Name",measures = c("Observed","Shannon"),color="Rookery")
```

# Heatmap  
```{r hm}
plot_heatmap((prune.ps.troph.1pct %>% subset_taxa(!is.na(Species))),taxa.label = 'Species',sample.order='Date',taxa.order='Family') + facet_wrap(~Rookery,scales='free')
#ggsave("/Users/lauragivens/Downloads/prune.1pct.heatmap.rookery.facet.png",width=15,height=5)
```

```{r}
ps.melt <- prune.ps.1pct %>% psmelt() 
ps.melt <- ps.melt %>% group_by(species) %>% reframe(Abund=sum(Abundance),Total=sum(.$Abundance),Perc=Abund/Total) %>% arrange(.,desc(Perc),.by_group=TRUE)

ps.melt$species <- factor(ps.melt$species,levels=ps.melt$species)

ggplot(ps.melt, aes(y=species,x=Perc,fill=species)) + geom_col() + theme(legend.position='none')
```

# Include these graphs in report  
Species richness per site 
```{r}
plot <- prune.ps.troph.t100 %>% psmelt() %>% filter(!is.na(Species)) %>%
  group_by(Rookery,Site,Species) %>% 
  #reframe(RelAbund = Abundance/sum(Abundance)) %>%
  ggplot(aes(x=Rookery,y=Abundance,fill=Species)) +
  #plot_bar(x='Rookery',fill = 'Species') + 
  geom_bar(stat='identity',position='stack') + 
  facet_grid(~Site) + 
  #theme(legend.position='none') +
 scale_color_viridis_d(end=0.9,option='turbo') + scale_fill_viridis_d(end=0.9,option='turbo') + 
  labs(title="Comparison of fish species occurrence at rookery and non-rookery mangrove cayes",
       caption="All sampling trips combined")

ggsave(plot,filename="/Users/lauragivens/Downloads/t100.rookery.png",height=10,width = 15,bg='white')
#plot_legend <- get_legend(plot)

#cowplot::plot_grid(plot,plot_legend,
#                   nrow=2,
#                   rel_heights = c(4,1))
```

relative abundance occurrence 
```{r}
prune.ps.troph.1pct %>% 
  transform_sample_counts(function(x) x/sum(x)) %>% subset_taxa(Commercially.Imp.Occurring.IN.Belize==TRUE & !is.na(Species)) %>%
  plot_bar(x="Date",fill="Species") + 
  geom_bar(aes(color=Species,fill=Species),stat='identity',position='stack') + 
  facet_grid(Site~Rookery) + scale_x_date(breaks = unique(samplelist$Date),date_labels='%b') +
 scale_color_viridis_d(end=0.9,option='plasma') + scale_fill_viridis_d(end=0.9,option='plasma') + 
  #scale_color_viridis_d(begin=0.1,option='inferno') + scale_fill_viridis_d(begin=0.1,option='inferno') +
  labs(x="Sampling Month (2023 - 2024)",
       y="Relative Abundance",
       title="Commercially important species in Belize at rookery and non-rookery mangrove cayes")
ggsave(filename="/Users/lauragivens/Downloads/commImp.BZ.relabund.png",height=8,width=12,bg='white')
```

Pattern in relative abundance species of interest in Belize
```{r}
prune.ps.troph.t100 %>% transform_sample_counts(function(x) x/sum(x)) %>% psmelt() %>%
#prune.ps.troph.melt.rel %>% 
  filter(str_detect(Common.name,"snapper") | str_detect(Common.name,"grunt")) %>% 
  filter(!is.na(Species)) %>% group_by(Date,Site,Rookery,Species) %>%
  reframe(Abundance=sum(Abundance)) %>%
  ggplot(.,
       aes(x=Date,y=Abundance,
           color=Site,
           linetype=Rookery)) + 
  geom_line(linewidth=1.5) + geom_path() + facet_grid(Site~Species) + 
  #scale_color_viridis_d(end=0.9,option='plasma') + scale_fill_viridis_d(end=0.9,option='plasma') +
 scale_color_viridis_d(begin=0.3,end=0.7,option='inferno') + scale_fill_viridis_d(begin=0.3,end=0.7,option='inferno')  +
  labs(x="Sampling Month (2023 - 2024)",
       y="Relative Abundance",
       title="Relative occurrence of snapper and grunt at rookery and non-rookery mangrove cayes")

ggsave(filename="/Users/lauragivens/Downloads/snapper.grunt.BZ.relabund.png",height=10,width=10,bg='white')
```

```{r}
prune.ps.troph.melt %>% 
  group_by(Date,Site,Rookery,Trophic.Round) %>% 
  summarize(Abundance=sum(Abundance)) %>% 
  mutate(Abundance=Abundance/sum(Abundance)) %>% filter(!is.na(Trophic.Round)) %>%
ggplot(.,
       aes(x=Date,y=Abundance,
           #group=Trophic.Round,
           color=Trophic.Round,
           linetype=Rookery)) + 
  geom_line(linewidth=1.5) + geom_path() + 
  #facet_grid(~Site) +
  facet_grid(Trophic.Round~Site) +
 scale_color_viridis_d(end=0.9,option='plasma') + scale_fill_viridis_d(end=0.9,option='plasma') + 
  guides(color=guide_legend(title="Trophic Index")) +
  labs(x="Sampling Month (2023 - 2024)",
       y="Relative Abundance",
       title="Species' trophic index at rookery and non-rookery mangrove cayes")

ggsave(filename="/Users/lauragivens/Downloads/trophic.BZ.relabund.png",height=10,width=10,bg='white')
```
Violin plot
```{r}
trip.labs <- c("Aug 2023","Nov 2023","Feb 2024","May 2024")
names(trip.labs) <- c("Trip 1: Summer 2023",
                      "Trip 2: Fall 2023",
                      "Trip 3: Winter 2024",
                      "Trip 4: Spring 2024")

prune.ps.troph.melt %>% mutate(Trophic.Base = as.numeric(Trophic.Base)) %>% filter(Abundance>0) %>%
  #group_by(Date,Site,Rookery,Trophic.Round) %>% 
  #summarize(Abundance=sum(Abundance)) %>% 
  #mutate(Abundance=Abundance/sum(Abundance)) %>% filter(!is.na(Trophic.Round)) %>%
ggplot(.,
       aes(x=Trip,
           #x=Rookery,
           #group=Trophic.Round,
           y=Trophic.Base,
           fill=Rookery)) + 
  facet_wrap(Rookery~Site,nrow=2) + 
  #facet_grid(Site~Trip,labeller=labeller(Trip=trip.labs)) + 
  geom_violin() + 
  #geom_jitter(shape=16, position=position_jitter(0.2)) + 
  geom_boxplot(width=0.15) +
 scale_color_viridis_d(begin=0.3,end=0.9,option='plasma') + scale_fill_viridis_d(begin=0.3,end=0.9,option='plasma') +
  scale_x_discrete(labels=trip.labs) + 
  labs(title="Species' trophic index at rookery and non-rookery mangrove cayes",
       y="Trophic Index",
       x="Date")
ggsave(filename="/Users/lauragivens/Downloads/trophic.violin.3.png",height=7,width=10,bg='white')
```


```{r session-info}
sessionInfo()
```
